# Paella


## Introduction 

Paella is a system for that has been used to install preconfigured 
debian systems over a local network in a manner similar to FAI_.  The 
project started in 2004 as a set of scripts within the FAI installer than 
communicated with a PostgreSQL database to retrieve the configuration for 
the target machine.

The old website for this project is at http://paella.berlios.de

## NEWS

- Paella is being rewritten completely.  

- [Vagrant](http://www.vagrantup.com/) is being used to create a 
  testing environment.

- Currently using i386 vagrant box running debian/wheezy

- Using Debian Installer via PXE for first stage install

- Using [salt](http://saltstack.org/) for second stage
  installation and configuration.

## Vagrant

Vagrant is used to establish a testing environment for paella.  The 
Vagrantfile creates a virtualbox machine with two network interfaces.  
The second network is a virtualbox internal network where the installation 
system is hosted.  The installation system can be tested by creating virtual 
machines and booting from the internal network to define and install the 
system.

At the moment, there is only the proof of concept installer that installs a 
minimal i386 system.

## Outline

How is paella going to work?

Two deployment scenarios:

1. Set up a network in the office or workplace of a person who creates servers 
   for people.  This person can use paella to create fully configured machines 
   that can be physically carried and installed at another location.

2. Set up a network where the hosts on the network are installed and managed 
   by a paella server.
  
### Install Routine

#### Default Live System

Boot a machine over the network.  The default boot menu will allow you to 
boot into a live system where you can identify the machine and set a flag 
on the server to install the machine.

Two scripts on the live system:

1. identify-machine <name>
   
   1. sends a name to the server
   
   2. the salt config should already have this name
   
   3. in the future, use web app to create machines from sls file list, etc.
   
   4. all mac addresses sent to server tied to name
   

2. install-machine
   
   1. machine must already be identified
   
   2. name lookup based on matching mac address
   
   3. command tells server to create special pxe config files named 
	  after mac addresses
   
   4. kernel command line has preseed url for machine
   

#### General Install Procedure  
Procedure when machine set to be installed:
 
1. Boot machine from network.
 
2. User must press enter to boot debian pxe image
 
3. preseed url specific to machine in kernel command line
 
4. preseed generated by pyramid string renderer
 
5. preseed contains saltstack apt repository
 
6. preseed installs base system and salt-minion
 
7. late command needs machine specific url to supply script to configure salt
 
8. late script sents http POST to server to tell server first stage install 
   completed
 
9. when server receives install complete post, it deletes pxe config files
 
10. machine reboots and second stage install continues with salt
 
### PXE Issues

Netbooting varies from machine to machine.  There are many machines that will 
not boot from the network unless a key, like F12, is pressed during the 
preboot.  

Other machines will readily boot from the network at first option.  I intend 
for paella to be flexible enough to handle these situations.  For example, 
instead of deleting the machine specific pxe config files in the tftpboot 
directory, those files could be modified to boot from the first hard drive, 
allowing the second stage installer to continue, rather than being stuck 
in a repeated install loop.

### Preseed builder

There needs to be a method of gather variables from a data source and 
generating a preseed file.  The preseed file needs to be managed in certain 
chunks; basic info, disk/partition config, apt info, and so on.  There needs to 
be a collection of disk configs that can be referred to by name, filling out 
the debconf selections for the preseed file.

The preseed is built dynamically and served through pyramid string renderer.

I desire most of the data to be stored and managed via salt.  The data for the 
preseed file should be contained in a salt pillar.  The master should be able 
to get the pillar data for the identified machine and fill the preseed file 
with that data.

### Pillar Data

The default pillar data is in a git repository.  I desire for these pillar 
files, eventually, to be python scripts that access a database using 
SQLAlchemy.


## TODO

- Make scripts for live netboot system to identify machines and set
  for install.
  
- Make server that accepts POST requests and assigns machine names 
  to mac addresses.
  
- Get server to render preseed files based on name of machine.

- Get server to create and destroy pxe config files for machines in 
  /var/lib/tftpboot.

- Setup scripts to help with partial repository

- Move more info into pillar data

- Create some simple disk/partition recipes to use as a starting 
  point.
  
- Automate key generation and preseed the keys during first stage 
  install.
  http://docs.saltstack.com/en/latest/topics/tutorials/preseed_key.html

## History

### What was it?

Paella was written over eight years ago, yet much of the core components 
have changed little since the project started approaching stability.  Some 
of the core code was removed into the useless project for use in other 
projects unrelated to paella.  The latest major change the the code was 
made in 2009, and I have been using paella to install systems consistently 
since then.  The code has proven itself to be a reliable framework, where 
the changes that are necessary to update the manner in which the installer 
operates can be handled through the hooks that the installer objects 
provide.

The other edge of this sword is that, in the attempt to design a flexible 
framework that can be directed almost entirely through the configuration, 
the code that actually executes the framework has remained sessile.  While 
this provides stability and predictability, it comes at a price.  At this 
point in time, many of the upstreams sources that paella depends upon have 
all been deprecated by world developers at large, in favor of sources that 
are being actively developed and maintained.  This effectively puts the 
future of paella in jeopardy if the framework isn't eventually modified 
to take advantages of the state of our shared codebase that have happened 
over the last eight years.

In the beginning, this code was written at a time where I was pressed to 
have a system to install the servers that I was responsible for installing 
and configuring to perform the function request by the client.  I needed a 
system that could install preconfigured systems in a reliable and predictable 
manner.  I had become familiar with FAI, and I started using this to meet 
my needs.  During this time, I felt that using a SQL database to hold 
the smaller particulars of the installation data would come in handy, due 
to the relational nature of the database.  While inheritance and 
hierarchies can become more involved with a relational database, the format 
is handy for performing many management activities with the configuration 
can become more difficult when the configuration is stored in a filesystem.

I also wanted to exceed some of the limitations that constrained me when 
using FAI.  The manner in which FAI operates depends on an nfs mount on 
a local network.  Paella, however, only needs access to the configuration 
database.  The live system that contains the installer can be run from 
nfs, cdrom, or usb.  This allows installation on machines that are don't 
have PXE capability, as well as allowing installation of servers where the 
configuration database is not located on the local network.  Furthermore, 
I desired to develop a gui to manipulate the configuration, and the sql 
database lent itself to quicker gui development.

### Features on Older Version
- Automated network installation over a local network.

- The configuration is split into conceptual entities that are
  organized in a manner that defines a machine by the functions 
  that it performs, the group of machines it belongs to according to 
  network, role, or any other criteria that you define.

- The boot media is created from debian live, which allows for nfs,
  cdrom, and usb media types.

- A gui exists to help manage the database.

- The installer system is very flexible, where each step in the 
  configuration is able to be overridden with a script.

- The system is split into independent packages that clearly describe 
  their requirements, attempting to relieve the bloat that can occur 
  when using a single source tree to provide functionality in 
  differing environments (for example, qt4 doesn't need to be present 
  on the installation systems).

- The system can be used to install preconfigured machines that are 
  ready to be deployed to another network, or it can be used to install 
  machines on the local network as a service.  The distinction depends upon 
  the configuration of the database.

- Paella works upon the principle that the value of an entity, such as a 
  hostname, should be stored in one place, then referenced from other places 
  as the need requires, rather than being copied. (http://paella.berlios.de/docs/abstract.html#one-location-for-a-variable)

- The structure of the database allows the administrator to distinguish 
  between logical and physical configurations.  This allows the administrator 
  to more easily upgrade a machine to a new physical configuration.
